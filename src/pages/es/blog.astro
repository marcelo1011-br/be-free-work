---
/* ================================
   BE FREE TOURS - Blog Hub (EspaÃ±ol)
   PÃ¡gina principal del blog
   ================================ */

import { Image } from "astro:assets";
import { getCollection } from "astro:content"; // IMPORTANTE: Importar getCollection
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import HeroPages from "../../components/HeroPages.astro";
import { useTranslations } from "../../i18n/utils";
import { getBlogSchema, getBreadcrumbSchema } from "../../utils/seoHelpers.js";

const lang = "es";
const t = useTranslations(lang);

// SEO
const siteUrl = Astro.site?.toString() || "https://befreetours.com.br";
const seo = {
  title: "Blog de Viajes a RÃ­o - Consejos, GuÃ­as e Historias | Be Free Tours",
  description:
    "Consejos expertos, guÃ­as internas e historias inspiradoras sobre RÃ­o de Janeiro. Desde playas escondidas hasta gastronomÃ­a local, descubre RÃ­o como nunca antes.",
};

// 1. Buscar posts REAIS da coleÃ§Ã£o
// Filtra apenas posts em Espanhol (slug comeÃ§a com 'es/')
// E ordena por data de publicaÃ§Ã£o (mais recente primeiro)
const allPosts = await getCollection("blog", ({ id }) => {
  return id.startsWith("es/");
});

const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf()
);

// Import das imagens do blog
const blogImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/images/blog/*.{jpeg,jpg,png,webp}"
);

// Helper para carregar imagem
async function getBlogImage(slug: string) {
  const possiblePaths = [
    `/src/images/blog/${slug}.webp`,
    `/src/images/blog/${slug}.jpg`,
    `/src/images/blog/${slug}.png`,
  ];

  for (const path of possiblePaths) {
    if (blogImages[path]) {
      const img = await blogImages[path]();
      return img.default;
    }
  }
  return null;
}

// Carregar imagens para cada post
const postsWithImages = await Promise.all(
  sortedPosts.map(async (post) => {
    // Remove o prefixo 'es/' do slug para a URL ficar limpa
    const cleanSlug = post.slug.split('/').pop();
    return {
      ...post.data,
      slug: cleanSlug,
      image: await getBlogImage(post.data.imageSlug),
    };
  })
);

// CategorÃ­as
const categories = [
  "Todas las Publicaciones",
  "Consejos de Viaje",
  "Joyas Escondidas",
  "Comida y Bebida",
  "Atracciones",
  "Cultura",
  "Historia",
  "Barrios",
];

// Schemas
const blogSchemaData = getBlogSchema(
  postsWithImages.map(p => ({
    slug: `${lang}/blog/${p.slug}`,
    data: { title: p.title, description: p.description }
  })),
  lang,
  siteUrl
);

// Breadcrumb
const breadcrumbItems = [
  { name: "Home", url: `/${lang}` },
  { name: "Blog", url: `/${lang}/blog` },
];
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbItems, siteUrl);

const schemas = [blogSchemaData, breadcrumbSchema];
---

<BaseLayout
  title={seo.title}
  description={seo.description}
  image="/images/og-blog.jpg"
  schema={schemas}
>
  <!-- Breadcrumbs -->
  <Breadcrumbs items={breadcrumbItems} />
  <!-- Hero Section -->
  <HeroPages
    title="Blog de Viajes a RÃ­o"
    subtitle="Consejos expertos, guÃ­as internas e historias inspiradoras de RÃ­o de Janeiro. Escritas por locales que conocen esta ciudad como la palma de su mano."
    maxWidth="clamp(34rem, 70vw, 43.75rem)"
  />

  <!-- Categories Filter -->
  <section class="blog-categories">
    <div class="container">
      <div class="categories-wrapper">
        {
          categories.map((category, index) => (
            <button
              class={`category-btn ${index === 0 ? "active" : ""}`}
              data-category={category}
            >
              {category}
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Blog Posts Grid -->
  <section class="blog-posts">
    <div class="container">
      <div class="posts-grid grid grid-3">
        {
          postsWithImages.map((post) => (
            <article class="post-card" data-category={post.category}>
              <a href={`/${lang}/blog/${post.slug}`} class="post-link">
                <div class="post-image">
                  {post.image ? (
                    <Image
                      src={post.image}
                      alt={post.title}
                      width={600}
                      height={400}
                      format="webp"
                      quality={80}
                    />
                  ) : (
                    <div class="image-placeholder">ðŸ“·</div>
                  )}
                  <span class="post-category">{post.category}</span>
                </div>
                <div class="post-content">
                  <div class="post-meta">
                    <time datetime={post.publishDate}>
                      {new Date(post.publishDate).toLocaleDateString("es-ES", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                    </time>
                    <span class="post-read-time">{post.readTime}</span>
                  </div>
                  <h2 class="post-title">{post.title}</h2>
                  <p class="post-excerpt">{post.description}</p>
                  <span class="read-more">Leer MÃ¡s â†’</span>
                </div>
              </a>
            </article>
          ))
        }
      </div>

      <!--
      <div class="newsletter-cta">
        <div class="newsletter-content">
          <h3>Recibe Consejos de Viaje a RÃ­o en tu Correo</h3>
          <p>
            Ãšnete a 5,000+ viajeros que reciben guÃ­as internas, joyas escondidas
            y descuentos exclusivos en tours.
          </p>
          <form
            class="newsletter-form"
            action="https://formspree.io/f/YOUR_FORM_ID"
            method="POST"
          >
            <input
              type="email"
              name="email"
              placeholder="Ingresa tu correo"
              required
              class="newsletter-input"
            />
            <button type="submit" class="btn btn-primary"> Suscribirse </button>
          </form>
          <p class="newsletter-note">Sin spam. Cancela cuando quieras. ðŸ“§</p>
        </div>
      -->      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero */
  .blog-hero {
    --blog-hero-offset: clamp(2rem, 6vw, 2.5rem);
    --blog-hero-offset-mobile: clamp(2.5rem, 8vw, 3.75rem);
    --blog-hero-content-max: clamp(34rem, 70vw, 43.75rem);

    padding: calc(var(--space-3xl) + var(--blog-hero-offset)) 0 var(--space-3xl);
    background: linear-gradient(
      135deg,
      var(--color-bg-dark) 0%,
      var(--color-primary) 50%,
      var(--color-bg-dark) 100%
    );
    color: var(--color-text-inverse);
    text-align: center;
  }

  .hero-content {
    max-width: var(--blog-hero-content-max);
    margin: 0 auto;
  }

  .hero-title {
    color: var(--color-text-inverse);
    margin-bottom: var(--space-md);
  }

  .hero-subtitle {
    font-size: var(--font-size-h6);
    color: color-mix(in srgb, var(--color-text-inverse) 90%, transparent);
    line-height: var(--line-height-relaxed);
  }

  /* Categories */
  .blog-categories {
    --blog-categories-border: var(--border-width-hairline);
    --category-padding-block: clamp(0.625rem, 1.2vw, 0.75rem);
    --category-padding-inline: clamp(1rem, 2vw, 1.25rem);
    --category-border-width: var(--border-width-regular);
    --category-transition: var(--transition-duration-slow) var(--transition-easing-default);

    padding: var(--space-xl) 0;
    background-color: var(--color-bg-soft);
    border-bottom: var(--blog-categories-border) solid var(--color-border);
  }

  .categories-wrapper {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    justify-content: center;
  }

  .category-btn {
    padding: var(--category-padding-block) var(--category-padding-inline);
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    border: var(--category-border-width) solid var(--color-border);
    border-radius: var(--radius-full);
    background-color: var(--color-bg-white);
    color: var(--color-text);
    cursor: pointer;
    transition: background-color var(--category-transition),
      border-color var(--category-transition),
      color var(--category-transition);
  }

  .category-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .category-btn.active {
    background: var(--gradient-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Fix for light theme - ensure text contrast */
  :root[data-theme="light"] .category-btn.active {
    background: var(--color-accent);
    color: white;
  }

  /* Posts Grid */
  .blog-posts {
    --blog-posts-offset: clamp(2rem, 6vw, 2.5rem);
    padding: calc(var(--space-3xl) + var(--blog-posts-offset)) 0 var(--space-3xl);
  }

  .posts-grid {
    margin-bottom: var(--space-3xl);
  }

  /* Post Card */
  .post-card {
    --post-card-border: var(--border-width-hairline);
    --post-card-lift: -4px;
    --post-card-shadow: 0 12px 24px color-mix(in srgb, black 10%, transparent);
    --post-card-transition: var(--transition-duration-normal) var(--transition-easing-default);
    --post-image-scale: 1.05;
    --post-category-padding-block: var(--space-2xs);
    --post-category-padding-inline: var(--space-md-compact);

    background-color: var(--color-bg-white);
    border: var(--post-card-border) solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition:
      transform var(--post-card-transition),
      box-shadow var(--post-card-transition);
  }

  .post-card:hover {
    transform: translateY(var(--post-card-lift));
    box-shadow: var(--post-card-shadow);
  }

  .post-link {
    display: block;
    color: inherit;
    text-decoration: none;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .post-image {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-duration-slow) var(--transition-easing-default);
  }

  .image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--glass-bg);
    color: var(--color-text-muted);
    font-size: var(--font-size-h1);
  }

  .post-card:hover .post-image img {
    transform: scale(var(--post-image-scale));
  }

  .post-category {
    position: absolute;
    top: var(--space-md);
    left: var(--space-md);
    padding: var(--post-category-padding-block) var(--post-category-padding-inline);
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-inverse);
    background-color: var(--color-accent);
    border-radius: var(--radius-full);
    z-index: 2;
  }

  .post-content {
    padding: var(--space-lg);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
    font-size: var(--font-size-small);
    color: var(--color-text-light);
  }

  .post-meta time {
    font-weight: var(--font-weight-medium);
  }

  .post-read-time::before {
    content: "â€¢";
    margin-right: var(--space-sm);
  }

  .post-title {
    font-size: var(--font-size-h5);
    margin-bottom: var(--space-sm);
    color: var(--color-text);
    line-height: var(--line-height-tight);
  }

  .post-excerpt {
    font-size: var(--font-size-body);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--space-md);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .read-more {
    margin-top: auto;
    display: inline-block;
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
    transition: color var(--transition-duration-normal) var(--transition-easing-default);
  }

  .post-card:hover .read-more {
    color: var(--color-accent);
  }

  /*
  .newsletter-cta {
    padding: var(--space-2xl);
    background: linear-gradient(
      135deg,
      var(--color-bg-dark) 0%,
      var(--color-primary) 50%,
      var(--color-bg-dark) 100%
    );
    border-radius: var(--radius-lg);
    text-align: center;
    color: var(--color-text-inverse);
  }
  */

  .newsletter-content {
    max-width: 600px;
    margin: 0 auto;
  }

  .newsletter-content h3 {
    font-size: var(--font-size-h3);
    color: var(--color-text-inverse);
    margin-bottom: var(--space-sm);
  }

  .newsletter-content > p {
    font-size: var(--font-size-h6);
    color: color-mix(in srgb, var(--color-text-inverse) 90%, transparent);
    margin-bottom: var(--space-lg);
  }

  .newsletter-form {
    display: flex;
    gap: var(--space-sm);
    max-width: 500px;
    margin: 0 auto var(--space-sm);
  }

  .newsletter-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    font-size: var(--font-size-body);
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    background-color: var(--color-text-inverse);
    color: var(--color-text);
  }

  .newsletter-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .newsletter-note {
    font-size: var(--font-size-small);
    color: rgba(255, 255, 255, 0.8);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .blog-hero {
      padding: calc(var(--space-3xl) + var(--blog-hero-offset-mobile)) 0 var(--space-xl);
    }

    .blog-categories {
      padding: var(--space-lg) 0;
    }

    .blog-posts {
      padding: var(--space-2xl) 0;
    }

    /*
    .newsletter-form {
      flex-direction: column;
    }

    .newsletter-cta {
      padding: var(--space-xl);
    }
    */
  }
</style>

<script>
  // Category filter functionality
  document.addEventListener("DOMContentLoaded", () => {
    const categoryBtns = document.querySelectorAll(".category-btn");
    const posts = document.querySelectorAll(".post-card");

    categoryBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        // 1. Gerenciar classe ativa nos botÃµes
        categoryBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        // 2. Filtrar posts
        const selectedCategory = btn.getAttribute("data-category");

        posts.forEach((post) => {
          if (selectedCategory === "Todas las Publicaciones") {
            (post as HTMLElement).style.display = "block";
          } else {
            const postCategory = post.getAttribute("data-category");
            if (postCategory === selectedCategory) {
              (post as HTMLElement).style.display = "block";
            } else {
              (post as HTMLElement).style.display = "none";
            }
          }
        });
      });
    });
  });
</script>
