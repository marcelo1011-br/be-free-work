---


import { Image } from "astro:assets";
import { getCollection } from "astro:content"; 
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import HeroPages from "../../components/HeroPages.astro";
import { useTranslations } from "../../i18n/utils";
import { getBlogSchema, getBreadcrumbSchema } from "../../utils/seoHelpers.js";

const lang = "en";
const t = useTranslations(lang);

const getEntryId = (post) => post.slug ?? post.id ?? "";
const getEntrySlug = (post) => {
  const raw = getEntryId(post);
  if (!raw) return "";
  const normalized = raw.replace(/^\/+/, "");
  const prefix = `${lang}/`;
  if (normalized.startsWith(prefix)) return normalized.slice(prefix.length);
  return normalized.split("/").pop() || normalized;
};

const siteUrl = (Astro.site?.toString() || "https://befreetours.com.br").replace(/\/$/, "");
const seo = {
  title: "Rio Travel Blog - Tips, Guides & Stories | Be Free Tours",
  description:
    "Expert travel tips, insider guides, and inspiring stories about Rio de Janeiro. From hidden beaches to local cuisine, discover Rio like never before.",
};




const allPosts = await getCollection("blog", ({ id, slug }) => {
  return (slug ?? id ?? "").startsWith(`${lang}/`);
});

const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf()
);


const blogImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/images/blog/*.{jpeg,jpg,png,webp}"
);


async function getBlogImage(slug: string) {
  const possiblePaths = [
    `/src/images/blog/${slug}.webp`,
    `/src/images/blog/${slug}.jpg`,
    `/src/images/blog/${slug}.png`,
  ];

  for (const path of possiblePaths) {
    if (blogImages[path]) {
      const img = await blogImages[path]();
      return img.default;
    }
  }
  return null;
}


const postsWithImages = await Promise.all(
  sortedPosts.map(async (post) => {
    
    const cleanSlug = getEntrySlug(post);
    return {
      ...post.data,
      slug: cleanSlug,
      image: await getBlogImage(post.data.imageSlug),
    };
  })
);


const blogSchemaData = getBlogSchema(
  postsWithImages.map(p => ({
    slug: `${lang}/blog/${p.slug}`,
    data: { title: p.title, description: p.description } 
  })),
  lang,
  siteUrl
);


const breadcrumbItems = [
  { name: "Home", url: `/${lang}` },
  { name: "Blog", url: `/${lang}/blog` },
];
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbItems, siteUrl);

const schemas = [blogSchemaData, breadcrumbSchema];


const categories = [
  "All Posts",
  "Travel Tips",
  "Hidden Gems",
  "Food & Drink",
  "Attractions",
  "Culture",
  "History",
  "Neighborhoods",
];
---

<BaseLayout
  title={seo.title}
  description={seo.description}
  image="/images/og-blog.svg"
  schema={schemas}
>
  
  <Breadcrumbs items={breadcrumbItems} />
  
  <HeroPages
    title="Rio Travel Blog"
    subtitle="Expert tips, insider guides, and inspiring stories from Rio de Janeiro. Written by locals who know this city like the back of their hand."
    maxWidth="clamp(34rem, 70vw, 43.75rem)"
  />

  
  <section class="blog-categories">
    <div class="container">
      <div class="categories-wrapper">
        {
          categories.map((category, index) => (
            <button
              class={`category-btn ${index === 0 ? "active" : ""}`}
              data-category={category}
            >
              {category}
            </button>
          ))
        }
      </div>
    </div>
  </section>

  
  <section class="blog-posts">
    <div class="container">
      <div class="posts-grid grid grid-3">
        {
          postsWithImages.map((post) => (
            <article class="post-card" data-category={post.category}>
              <a href={`/${lang}/blog/${post.slug}`} class="post-link">
                <div class="post-image">
                  {post.image ? (
                    <Image
                      src={post.image}
                      alt={post.title}
                      width={400}
                      height={225}
                      format="webp"
                      quality={80}
                    />
                  ) : (
                    <div class="image-placeholder">ðŸ“·</div>
                  )}
                  <span class="post-category">{post.category}</span>
                </div>
                <div class="post-content">
                  <div class="post-meta">
                    <time datetime={post.publishDate}>
                      {new Date(post.publishDate).toLocaleDateString("en-US", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                    </time>
                    <span class="post-read-time">{post.readTime}</span>
                  </div>
                  <h2 class="post-title">{post.title}</h2>
                  <p class="post-excerpt">{post.description}</p>
                  <span class="read-more">Read More â†’</span>
                </div>
              </a>
            </article>
          ))
        }
      </div>

      
    </div>
  </section>
</BaseLayout>

<style>
  
  .blog-hero {
    --blog-hero-offset: clamp(2rem, 6vw, 2.5rem);
    --blog-hero-offset-mobile: clamp(2.5rem, 8vw, 3.75rem);
    --blog-hero-content-max: clamp(34rem, 70vw, 43.75rem);

    padding: calc(var(--space-3xl) + var(--blog-hero-offset)) 0 var(--space-3xl);
    background: linear-gradient(
      135deg,
      var(--color-bg-dark) 0%,
      var(--color-primary) 50%,
      var(--color-bg-dark) 100%
    );
    color: var(--color-text-inverse);
    text-align: center;
  }

  .hero-content {
    max-width: var(--blog-hero-content-max);
    margin: 0 auto;
  }

  .hero-title {
    color: var(--color-text-inverse);
    margin-bottom: var(--space-md);
  }

  .hero-subtitle {
    font-size: var(--font-size-h6);
    color: color-mix(in srgb, var(--color-text-inverse) 90%, transparent);
    line-height: var(--line-height-relaxed);
  }

  
  .blog-categories {
    --blog-categories-border: var(--border-width-hairline);
    --category-padding-block: clamp(0.625rem, 1.2vw, 0.75rem);
    --category-padding-inline: clamp(1rem, 2vw, 1.25rem);
    --category-border-width: var(--border-width-regular);
    --category-transition: var(--transition-duration-slow) var(--transition-easing-default);

    padding: var(--space-xl) 0;
    background-color: var(--color-bg-soft);
    border-bottom: var(--blog-categories-border) solid var(--color-border);
  }

  .categories-wrapper {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    justify-content: center;
  }

  .category-btn {
    padding: var(--category-padding-block) var(--category-padding-inline);
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    border: var(--category-border-width) solid var(--color-border);
    border-radius: var(--radius-full);
    background-color: var(--color-bg-white);
    color: var(--color-text);
    cursor: pointer;
    transition: background-color var(--category-transition),
      border-color var(--category-transition),
      color var(--category-transition);
  }

  .category-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .category-btn.active {
    background: var(--gradient-accent);
    border-color: var(--color-accent);
    color: white;
  }

  
  :root[data-theme="light"] .category-btn.active {
    background: var(--color-accent);
    color: white;
  }

  
  .blog-posts {
    padding: var(--space-3xl) 0;
  }

  .blog-posts .container {
    max-width: none;
    padding-inline: var(--space-xl-compact);
  }

  .posts-grid {
    margin-bottom: var(--space-3xl);
    gap: var(--space-md);
  }

  @media (min-width: 1200px) {
    .posts-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
  }

  
  .post-card {
    --post-card-border: var(--border-width-hairline);
    --post-card-lift: -4px;
    --post-card-shadow: 0 12px 24px color-mix(in srgb, black 10%, transparent);
    --post-card-transition: var(--transition-duration-normal) var(--transition-easing-default);
    --post-image-scale: 1.05;
    --post-category-padding-block: var(--space-2xs);
    --post-category-padding-inline: var(--space-md-compact);

    background-color: var(--color-bg-white);
    border: var(--post-card-border) solid var(--color-border);
    border-radius: clamp(0.3rem, 0.6vw, 0.375rem);
    overflow: hidden;
    transition:
      transform var(--post-card-transition),
      box-shadow var(--post-card-transition);
  }

  .post-card:hover {
    transform: translateY(var(--post-card-lift));
    box-shadow: var(--post-card-shadow);
  }

  .post-link {
    display: block;
    color: inherit;
    text-decoration: none;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .post-image {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .post-image img,
  .post-image :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-duration-slow) var(--transition-easing-default);
  }

  .image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--glass-bg);
    color: var(--color-text-muted);
    font-size: var(--font-size-h1);
  }

  .post-card:hover .post-image img {
    transform: scale(var(--post-image-scale));
  }

  .post-category {
    position: absolute;
    top: var(--space-md);
    left: var(--space-md);
    padding: var(--post-category-padding-block) var(--post-category-padding-inline);
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    color: white;
    background-color: var(--color-accent);
    border-radius: var(--radius-full);
    z-index: 2;
  }

  .post-content {
    padding: var(--space-lg);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
    font-size: var(--font-size-small);
    color: var(--color-text-light);
  }

  .post-meta time {
    font-weight: var(--font-weight-medium);
  }

  .post-read-time::before {
    content: "â€¢";
    margin-right: var(--space-sm);
  }

  .post-title {
    font-size: var(--font-size-h5);
    margin-bottom: var(--space-sm);
    color: var(--color-text);
    line-height: var(--line-height-tight);
  }

  .post-excerpt {
    font-size: var(--font-size-body);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--space-md);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .read-more {
    margin-top: auto;
    display: inline-block;
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-semibold);
    color: var(--color-accent);
    transition: color var(--transition-duration-normal) var(--transition-easing-default);
  }

  .post-card:hover .read-more {
    color: var(--color-accent-light);
  }

  

  
  @media (max-width: 768px) {
    .blog-hero {
      padding: calc(var(--space-3xl) + var(--blog-hero-offset-mobile)) 0 var(--space-xl);
    }

    .hero-title {
      font-size: var(--font-size-h3);
    }

    .hero-subtitle {
      font-size: var(--font-size-body);
    }

    .blog-categories {
      padding: var(--space-lg) 0;
    }

    .blog-posts {
      padding: var(--space-2xl) 0;
    }

    .post-title {
      font-size: var(--font-size-body);
    }

    .post-excerpt {
      font-size: var(--font-size-small);
    }

    .read-more {
      color: var(--color-accent);
    }

    
  }
</style>

<script>
  
  document.addEventListener("DOMContentLoaded", () => {
    const categoryBtns = document.querySelectorAll(".category-btn");
    const posts = document.querySelectorAll(".post-card");

    categoryBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        
        categoryBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        
        const selectedCategory = btn.getAttribute("data-category");

        posts.forEach((post) => {
          
          
          
          

          if (selectedCategory === "All Posts") {
            (post as HTMLElement).style.display = "block";
          } else {
            const postCategory = post.getAttribute("data-category");
            if (postCategory === selectedCategory) {
              (post as HTMLElement).style.display = "block";
            } else {
              (post as HTMLElement).style.display = "none";
            }
          }
        });
      });
    });
  });
</script>
