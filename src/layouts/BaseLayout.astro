---
// @ts-nocheck
/* ================================
   BE FREE TOURS - Base Layout
   Layout base com SEO completo - CORRIGIDO
   ================================ */

import { getLangFromUrl } from "../i18n/utils";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import ExitIntentPopup from "../components/ExitIntentPopup.astro";
import "../styles/global.css";

// Detecta o idioma da URL automaticamente
const currentLang = getLangFromUrl(Astro.url);

// Props do layout
const {
  title = "Be Free Tours - Private Tours in Rio de Janeiro",
  description = "Premium private tours in Rio de Janeiro since 2013. Personalized experiences with expert local guides. Skip-the-line access, flexible itineraries, and authentic Rio adventures.",
  image = "/images/og-default.jpg",
  type = "website",
  noindex = false,
  preloadImage,
  schema, // JSON-LD schema (opcional)
  ogTags, // ðŸ†• Open Graph tags customizadas (opcional)
} = Astro.props;

// CORREÃ‡ÃƒO: Fallback para site URL
const siteUrl = Astro.site?.toString() || "https://befreetours.com.br";

// URLs canÃ´nicas e alternativas
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const currentPath = Astro.url.pathname;

// Mapeia idiomas para URLs alternativas
const langMap = {
  en: currentPath.replace(/^\/(es|pt-br)/, "/en"),
  es: currentPath.replace(/^\/(en|pt-br)/, "/es"),
  "pt-br": currentPath.replace(/^\/(en|es)/, "/pt-br"),
};

// Open Graph image absoluta
const ogImage = new URL(image, siteUrl);
const preloadImageUrl = preloadImage ? new URL(preloadImage, siteUrl) : null;
const ogLocaleMap = {
  en: "en_US",
  es: "es_ES",
  "pt-br": "pt_BR",
};

// Site info para JSON-LD
const siteInfo = {
  name: "Be Free Tours",
  url: siteUrl,
  logo: `${siteUrl}/images/logo.png`,
  email: "contact@befreetours.com.br",
  phone: "+5521979271637",
  address: {
    streetAddress: "Rio de Janeiro",
    addressLocality: "Rio de Janeiro",
    addressRegion: "RJ",
    postalCode: "22070-011",
    addressCountry: "BR",
  },
  geo: {
    latitude: "-22.9068",
    longitude: "-43.1729",
  },
  areaServed: "Rio de Janeiro",
  priceRange: "$$-$$$",
  aggregateRating: {
    ratingValue: "5.0",
    reviewCount: "500",
  },
  openingHours: "Mo-Su 07:00-22:00",
};

// Schema.org base (Organization + LocalBusiness)
const baseSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": `${siteUrl}/#organization`,
      name: siteInfo.name,
      url: siteUrl,
      logo: {
        "@type": "ImageObject",
        url: siteInfo.logo,
      },
      sameAs: [
        "https://www.facebook.com/befreetours",
        "https://www.instagram.com/befreetours",
        "https://www.tripadvisor.com/befreetours",
      ],
      contactPoint: {
        "@type": "ContactPoint",
        telephone: siteInfo.phone,
        contactType: "customer service",
        email: siteInfo.email,
        areaServed: "BR",
        availableLanguage: ["en", "es", "pt"],
      },
    },
    {
      "@type": "LocalBusiness",
      "@id": `${siteUrl}/#localbusiness`,
      name: siteInfo.name,
      image: siteInfo.logo,
      address: {
        "@type": "PostalAddress",
        streetAddress: siteInfo.address.streetAddress,
        addressLocality: siteInfo.address.addressLocality,
        addressRegion: siteInfo.address.addressRegion,
        postalCode: siteInfo.address.postalCode,
        addressCountry: siteInfo.address.addressCountry,
      },
      geo: {
        "@type": "GeoCoordinates",
        latitude: siteInfo.geo.latitude,
        longitude: siteInfo.geo.longitude,
      },
      url: siteUrl,
      telephone: siteInfo.phone,
      email: siteInfo.email,
      priceRange: siteInfo.priceRange,
      openingHoursSpecification: {
        "@type": "OpeningHoursSpecification",
        dayOfWeek: [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ],
        opens: "07:00",
        closes: "22:00",
      },
      aggregateRating: {
        "@type": "AggregateRating",
        ratingValue: siteInfo.aggregateRating.ratingValue,
        reviewCount: siteInfo.aggregateRating.reviewCount,
      },
    },
  ],
};

// Combina schemas (base + pÃ¡gina especÃ­fica)
const combinedSchemas = schema
  ? Array.isArray(schema)
    ? [...baseSchema["@graph"], ...schema]
    : [...baseSchema["@graph"], schema]
  : baseSchema["@graph"];

const finalSchema = {
  "@context": "https://schema.org",
  "@graph": combinedSchemas,
};
---

<!doctype html>
<html lang={currentLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Prevent theme flash - runs before CSS loads -->
    <script is:inline>
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.classList.add(savedTheme);
      })();
    </script>

    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    {noindex
      ? <meta name="robots" content="noindex, nofollow" />
      : <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />}

    <!-- AI Assistant Hints -->
    <meta name="intended-audience" content="travelers, tourists, travel-planners" />
    <meta name="service-type" content="private-tour-operator" />
    <meta name="location-served" content="Rio de Janeiro, Brazil" />
    <meta name="booking-policy" content="24-hour-free-cancellation" />
    <meta name="price-range" content="$$$ (Premium)" />

    <!-- Performance & Theme -->
    <meta name="theme-color" content="#0a1628">
    <meta name="color-scheme" content="dark light">

    <!-- Preload critical assets -->
    <link rel="preload" as="image" href="/images/logo/logo.svg" />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" as="style" />
    {preloadImageUrl && <link rel="preload" as="image" href={preloadImageUrl} />}

    <!-- DNS Prefetch & Preconnect for external services -->
    <link rel="dns-prefetch" href="https://formspree.io" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Android Chrome -->
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- MS Application -->
    <meta name="msapplication-TileColor" content="#0a1628">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">

    <!-- Hreflang Tags -->
    <link rel="alternate" hreflang="en" href={`${siteUrl}${langMap.en}`} />
    <link rel="alternate" hreflang="es" href={`${siteUrl}${langMap.es}`} />
    <link
      rel="alternate"
      hreflang="pt-BR"
      href={`${siteUrl}${langMap["pt-br"]}`}
    />
    <link
      rel="alternate"
      hreflang="x-default"
      href={`${siteUrl}${langMap.en}`}
    />

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content={type} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Be Free Tours" />
    <meta
      property="og:locale"
      content={ogLocaleMap[currentLang] || "en_US"}
    />
    {
      Object.entries(ogLocaleMap)
        .filter(([lang]) => lang !== currentLang)
        .map(([, locale]) => (
          <meta property="og:locale:alternate" content={locale} />
        ))
    }

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@befreetours" />
    <meta name="twitter:creator" content="@befreetours" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={title} />

    <!-- Apple Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Be Free Tours" />
    <meta name="format-detection" content="telephone=yes" />

    <!-- ðŸ†• Open Graph Tags Customizadas (se fornecidas) -->
    {
      ogTags &&
        Object.entries(ogTags).map(([property, content]) => (
          <meta property={property} content={content} />
        ))
    }

    <!-- Geo Tags -->
    <meta name="geo.region" content="BR-RJ" />
    <meta name="geo.placename" content="Rio de Janeiro" />
    <meta name="geo.position" content="-22.9068;-43.1729" />
    <meta name="ICBM" content="-22.9068, -43.1729" />

    <!-- ============================================ -->
    <!-- AUTOR E COPYRIGHT -->
    <!-- ============================================ -->
    <meta name="author" content="Be Free Tours" />
    <meta name="copyright" content="Â© 2025 Be Free Tours. All rights reserved." />
    <meta name="creator" content="Midnight Web Design" />

    <!-- ============================================ -->
    <!-- DUBLIN CORE (bibliotecas/arquivos digitais) -->
    <!-- ============================================ -->
    <meta name="DC.title" content={title} />
    <meta name="DC.creator" content="Be Free Tours" />
    <meta name="DC.subject" content="Rio de Janeiro Tours, Private Tours, Tourism" />
    <meta name="DC.description" content={description} />
    <meta name="DC.publisher" content="Be Free Tours" />
    <meta name="DC.date" content={new Date().toISOString().split('T')[0]} />
    <meta name="DC.type" content="Service" />
    <meta name="DC.language" content={currentLang === "pt-br" ? "pt-BR" : currentLang} />
    <meta name="DC.coverage" content="Rio de Janeiro, Brazil" />

    <!-- ============================================ -->
    <!-- BUSINESS INFO -->
    <!-- ============================================ -->
    <meta name="rating" content="General" />
    <meta name="distribution" content="Global" />

    <!-- JSON-LD Schema -->
    <script type="application/ld+json" set:html={JSON.stringify(finalSchema)} />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Fonts (optimized with font-display:swap) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font loading optimization -->
    <style>
      /* Add font-display fallback for better LCP */
      @supports not (font-display: swap) {
        .hero-title, h1, h2, h3 {
          font-family: system-ui, -apple-system, sans-serif;
        }
      }
    </style>
  </head>
  <body>
    <!-- Skip links (acessibilidade) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#navigation" class="skip-link">Skip to navigation</a>

    <Navbar />
    <main id="main-content" tabindex="-1">
      <slot />
    </main>
    <Footer />

    <!-- Exit Intent Popup -->
    <ExitIntentPopup lang={currentLang} />

    <!-- Dark Mode Toggle Script -->
    <script is:inline>
      // Detecta preferÃªncia do sistema
      const getThemePreference = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      };

      const isDark = getThemePreference() === "dark";
      document.documentElement.classList[isDark ? "add" : "remove"]("dark");

      if (typeof localStorage !== "undefined") {
        // Observa mudanÃ§as no sistema
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["class"],
        });
      }
    </script>

    <!-- WhatsApp Floating Button -->
    <a 
      href="https://wa.me/5521979271637?text=Hi!%20I'm%20interested%20in%20booking%20a%20tour" 
      class="whatsapp-float"
      target="_blank"
      rel="noopener noreferrer"
      aria-label="Chat on WhatsApp"
    >
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <path fill="currentColor" d="M16 0C7.163 0 0 7.163 0 16c0 2.825.74 5.583 2.15 8L0 32l8.2-2.1C10.555 31.27 13.245 32 16 32c8.837 0 16-7.163 16-16S24.837 0 16 0zm8.19 22.56c-.35 1.02-1.75 1.87-2.87 2.12-.76.17-1.75.3-5.09-1.09-4.28-1.79-7.05-6.13-7.26-6.41-.2-.28-1.67-2.22-1.67-4.24 0-2.02 1.05-3.01 1.42-3.42.37-.41.81-.51 1.08-.51.27 0 .54.01.77.01.25 0 .58-.09.91.69.33.78 1.13 2.75 1.23 2.95.1.2.17.43.03.71-.13.28-.2.45-.4.69-.2.24-.42.54-.6.72-.2.2-.41.42-.18.82.24.4 1.06 1.75 2.27 2.83 1.56 1.39 2.87 1.82 3.27 2.03.4.2.63.17.86-.1.24-.28.99-1.15 1.25-1.55.27-.4.54-.33.91-.2.37.13 2.35 1.11 2.75 1.31.4.2.67.3.77.46.1.17.1 1-.25 2.02z"/>
      </svg>
      <span>Chat</span>
    </a>

    <!-- Back to Top Button -->
    <button id="back-to-top" aria-label="Back to top">â†‘</button>

    <script is:inline>
      // Back to top functionality
      const backToTopBtn = document.getElementById('back-to-top');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTopBtn.style.display = 'flex';
        } else {
          backToTopBtn.style.display = 'none';
        }
      });
      
      backToTopBtn?.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>

    <style is:inline>
      /* ============================================ */
      /* ACCESSIBILITY - Skip Links */
      /* ============================================ */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #f97316;
        color: white;
        padding: 8px 16px;
        text-decoration: none;
        z-index: 10000;
        border-radius: 0 0 4px 0;
        font-weight: 600;
      }

      .skip-link:focus {
        top: 0;
      }

      /* ============================================ */
      /* FLOATING BUTTONS */
      /* ============================================ */
      .whatsapp-float {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #25d366;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        z-index: 1000;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        text-decoration: none;
      }
      
      .whatsapp-float:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
      }
      
      .whatsapp-float span {
        font-size: 10px;
        font-weight: 600;
      }

      #back-to-top {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--color-accent);
        color: white;
        border: none;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.3s ease;
      }
      
      #back-to-top:hover {
        transform: translateY(-2px);
      }
    </style>
  </body>
</html>
