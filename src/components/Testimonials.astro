---
// @ts-nocheck
/* ================================
   BE FREE TOURS - Testimonials Component
   Seção de depoimentos com 2 níveis de expansão
   ================================ */

import { testimonials } from "../data/testimonials.js";
import { useTranslations } from "../i18n/utils";

const { lang } = Astro.props;
const t = useTranslations(lang);

// Separa os depoimentos em 3 grupos
const firstThree = testimonials.slice(0, 3); // Cards 1, 2, 3 - sempre visíveis inicialmente
const secondThree = testimonials.slice(3, 6); // Cards 4, 5, 6 - aparecem na 1ª expansão
const lastThree = testimonials.slice(6, 9); // Cards 7, 8, 9 - aparecem na 2ª expansão

// Função pra criar estrelas (5 estrelas preenchidas)
const renderStars = (rating) => {
  return "★".repeat(rating) + "☆".repeat(5 - rating);
};
---

<section class="testimonials">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">{t("testimonials.title")}</h2>
      <p class="section-subtitle">
        {t("testimonials.subtitle")}
      </p>
    </div>

    <div class="testimonials-grid">
      <!-- GRUPO 1: Primeiros 3 cards (sempre visíveis) -->
      {
        firstThree.map((testimonial) => (
          <article class="testimonial-card" data-group="1">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }

      <!-- GRUPO 2: Cards 4-6 (aparecem na 1ª expansão) -->
      {
        secondThree.map((testimonial) => (
          <article class="testimonial-card hidden" data-group="2">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }

      <!-- GRUPO 3: Cards 7-9 (aparecem na 2ª expansão) -->
      {
        lastThree.map((testimonial) => (
          <article class="testimonial-card hidden" data-group="3">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }
    </div>

    <!-- Botão para expandir/colapsar -->
    <div class="section-cta">
      <button
        id="testimonials-toggle"
        class="btn btn-outline-primary btn-lg"
        data-text-more={t("testimonials.readMore")}
        data-text-less={t("testimonials.showLess")}
      >
        {t("testimonials.readMore")}
      </button>
    </div>
  </div>
</section>

<style>
  .testimonials {
    --testimonials-header-max: clamp(40rem, 75vw, 50rem);
    --testimonials-grid-min: 350px;
    --testimonial-blur: var(--blur-md);
    --testimonial-border: var(--border-width-hairline);
    --testimonial-lift: -4px;
    --testimonial-shadow: 0 12px 24px color-mix(in srgb, black 30%, transparent);
    --testimonial-transition: var(--transition-duration-slow) var(--transition-easing-default);
    --testimonial-fade-duration: 0.5s;
    --testimonial-fade-offset: 20px;
    --testimonial-author-gap: var(--space-2xs);
    --testimonial-link-transition: color var(--transition-duration-normal) var(--transition-easing-default);
    --tripadvisor-green: #00aa6c;

    padding: var(--space-3xl) 0;
    background-color: var(--color-bg-soft);
  }

  .section-header {
    text-align: center;
    max-width: var(--testimonials-header-max);
    margin: 0 auto var(--space-2xl);
  }

  .section-title {
    color: var(--color-text);
    margin-bottom: var(--space-md);
  }

  .section-subtitle {
    font-size: var(--font-size-h5);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
  }

  .testimonials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, var(--testimonials-grid-min)), 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
  }

  .testimonial-card {
    padding: var(--space-xl);
    background: var(--glass-bg);
    backdrop-filter: blur(var(--testimonial-blur));
    -webkit-backdrop-filter: blur(var(--testimonial-blur));
    border: var(--testimonial-border) solid var(--glass-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--glass-shadow);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: transform var(--testimonial-transition), box-shadow var(--testimonial-transition);
  }

  .testimonial-card:hover {
    transform: translateY(var(--testimonial-lift));
    box-shadow: var(--testimonial-shadow);
  }

  /* Cards escondidos */
  .testimonial-card.hidden {
    display: none;
  }

  /* Animação de entrada quando mostra */
  .testimonial-card.show {
    display: flex;
    animation: fadeIn var(--testimonial-fade-duration) var(--transition-easing-default);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(var(--testimonial-fade-offset));
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .testimonial-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: var(--space-sm);
    border-bottom: var(--testimonial-border) solid var(--color-border-light);
  }

  .testimonial-rating {
    font-size: var(--font-size-h5);
    color: var(--color-accent);
  }

  .testimonial-source {
    font-size: var(--font-size-small);
    color: var(--tripadvisor-green); /* Verde TripAdvisor */
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
  }

  .testimonial-source:hover {
    text-decoration: underline;
  }

  .testimonial-title {
    font-size: var(--font-size-h5);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    line-height: var(--line-height-tight);
    margin: 0;
  }

  .testimonial-text {
    font-size: var(--font-size-body);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
    margin: 0;
    flex-grow: 1;
  }

  .testimonial-footer {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: var(--testimonial-border) solid var(--color-border-light);
  }

  .testimonial-author {
    display: flex;
    flex-direction: column;
    gap: var(--testimonial-author-gap);
  }

  .testimonial-author strong {
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }

  .testimonial-author span {
    font-size: var(--font-size-small);
    color: var(--color-text-muted);
  }

  .testimonial-tour-link {
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    color: var(--color-accent);
    transition: var(--testimonial-link-transition);
    align-self: flex-start;
  }

  .testimonial-tour-link:hover {
    color: var(--color-accent-light);
  }

  .section-cta {
    text-align: center;
  }

  /* Responsivo */
  @media (max-width: 768px) {
    .testimonials {
      padding: var(--space-2xl) 0;
    }

    .section-header {
      margin-bottom: var(--space-xl);
      padding-inline: var(--space-md);
    }

    .section-subtitle {
      font-size: var(--font-size-body);
    }

    .testimonials-grid {
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .testimonial-card {
      padding: var(--space-md);
    }

    .testimonial-title {
      font-size: var(--font-size-body);
    }

    .testimonial-text {
      font-size: var(--font-size-small);
    }
  }
</style>

<script>
  /* ================================
     JAVASCRIPT - Lógica de 2 Níveis de Expansão
     ================================ */

  // 1. Pega os elementos do DOM
  const toggleButton = document.getElementById("testimonials-toggle");
  const allCards = document.querySelectorAll(".testimonial-card");

  // 2. Variável pra controlar o nível de expansão (0, 1, ou 2)
  let expansionLevel = 0;

  // 3. Função que atualiza a visualização baseado no nível
  function updateTestimonials() {
    // Para cada card, verifica qual grupo ele pertence
    allCards.forEach((card) => {
      const groupAttr = card.getAttribute("data-group");
      const group = groupAttr ? parseInt(groupAttr) : 0;

      // Lógica de visibilidade:
      if (expansionLevel === 0) {
        // Nível 0: só mostra grupo 1
        if (group === 1) {
          card.classList.remove("hidden");
          card.classList.add("show");
        } else {
          card.classList.add("hidden");
          card.classList.remove("show");
        }
      } else if (expansionLevel === 1) {
        // Nível 1: mostra grupos 1 e 2
        if (group === 1 || group === 2) {
          card.classList.remove("hidden");
          card.classList.add("show");
        } else {
          card.classList.add("hidden");
          card.classList.remove("show");
        }
      } else if (expansionLevel === 2) {
        // Nível 2: mostra todos (grupos 1, 2 e 3)
        card.classList.remove("hidden");
        card.classList.add("show");
      }
    });

    // Atualiza o texto do botão baseado no nível
    if (expansionLevel === 0 || expansionLevel === 1) {
      if (toggleButton) {
        toggleButton.textContent =
          toggleButton.getAttribute("data-text-more") || "Read More Reviews";
      }
    } else {
      if (toggleButton) {
        toggleButton.textContent =
          toggleButton.getAttribute("data-text-less") || "Show Less";
      }
    }
  }

  // 4. Adiciona evento de clique no botão
  toggleButton?.addEventListener("click", () => {
    // Avança o nível (0 → 1 → 2 → 0 → 1 → 2...)
    expansionLevel = (expansionLevel + 1) % 3;

    // Se voltou pra 0, faz scroll suave pra seção
    if (expansionLevel === 0) {
      document.querySelector(".testimonials")?.scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    }

    // Atualiza a visualização
    updateTestimonials();
  });

  // 5. Inicializa na primeira carga (mostra só grupo 1)
  updateTestimonials();
</script>
