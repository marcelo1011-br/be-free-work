---



import { testimonials } from "../data/testimonials.js";
import { useTranslations } from "../i18n/utils";

const { lang } = Astro.props;
const t = useTranslations(lang);


const firstFour = testimonials.slice(0, 4);
const secondFour = testimonials.slice(4, 8);
const thirdFour = testimonials.slice(8, 12);
const fourthGroup = testimonials.slice(12, 16);


const renderStars = (rating) => {
  return "★".repeat(rating) + "☆".repeat(5 - rating);
};
---

<section class="testimonials">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">{t("testimonials.title")}</h2>
      <p class="section-subtitle">
        {t("testimonials.subtitle")}
      </p>
    </div>

    <div class="testimonials-grid">
      
      {
        firstFour.map((testimonial) => (
          <article class="testimonial-card" data-group="1">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }

      
      {
        secondFour.map((testimonial) => (
          <article class="testimonial-card hidden" data-group="2">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }

      
      {
        thirdFour.map((testimonial) => (
          <article class="testimonial-card hidden" data-group="3">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }

      {
        fourthGroup.map((testimonial) => (
          <article class="testimonial-card hidden" data-group="4">
            <div class="testimonial-header">
              <div class="testimonial-rating">
                {renderStars(testimonial.rating)}
              </div>
              {testimonial.sourceUrl ? (
                <a
                  class="testimonial-source"
                  href={testimonial.sourceUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {testimonial.source}
                </a>
              ) : (
                <span class="testimonial-source">{testimonial.source}</span>
              )}
            </div>

            <h3 class="testimonial-title">{testimonial.title}</h3>

            <p class="testimonial-text">{testimonial.text}</p>

            <div class="testimonial-footer">
              <div class="testimonial-author">
                <strong>{testimonial.name}</strong>
                <span>
                  {testimonial.country} • {testimonial.date}
                </span>
              </div>
              <a
                href={`/${lang}/tours/${testimonial.tourSlug[lang]}`}
                class="testimonial-tour-link"
              >
                {t("testimonials.viewTour")} →
              </a>
            </div>
          </article>
        ))
      }
    </div>

    
    <div class="section-cta">
      <button
        id="testimonials-toggle"
        class="btn btn-outline-primary btn-lg"
        data-text-more={t("testimonials.readMore")}
        data-text-less={t("testimonials.showLess")}
      >
        <span class="testimonials-toggle-label">{t("testimonials.readMore")}</span>
        <svg class="testimonials-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<style>
  .testimonials {
    --testimonials-header-max: clamp(40rem, 75vw, 50rem);
    --testimonials-grid-min: 350px;
    --testimonial-blur: var(--blur-md);
    --testimonial-border: var(--border-width-hairline);
    --testimonial-lift: -4px;
    --testimonial-shadow: 0 12px 24px color-mix(in srgb, black 30%, transparent);
    --testimonial-transition: var(--transition-duration-slow) var(--transition-easing-default);
    --testimonial-fade-duration: 0.5s;
    --testimonial-fade-offset: 20px;
    --testimonial-author-gap: var(--space-2xs);
    --testimonial-link-transition: color var(--transition-duration-normal) var(--transition-easing-default);
    --tripadvisor-green: #00aa6c;

    padding: var(--space-3xl) 0;
    background-color: var(--color-bg-soft);
  }

  .testimonials .container {
    max-width: none;
    padding-inline: var(--space-xl-compact);
  }

  .section-header {
    text-align: center;
    max-width: var(--testimonials-header-max);
    margin: 0 auto var(--space-2xl);
  }

  .section-title {
    color: var(--color-text);
    margin-bottom: var(--space-md);
  }

  .section-subtitle {
    font-size: var(--font-size-h5);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
  }

  .testimonials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, var(--grid-min-4)), 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-2xl);
  }

  @media (min-width: 1200px) {
    .testimonials-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
  }

  .testimonial-card {
    padding: var(--space-xl);
    background: var(--glass-bg);
    backdrop-filter: blur(var(--testimonial-blur));
    -webkit-backdrop-filter: blur(var(--testimonial-blur));
    border: var(--testimonial-border) solid var(--glass-border);
    border-radius: clamp(0.3rem, 0.6vw, 0.375rem);
    box-shadow: var(--glass-shadow);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: transform var(--testimonial-transition), box-shadow var(--testimonial-transition);
  }

  .testimonial-card:hover {
    transform: translateY(var(--testimonial-lift));
    box-shadow: var(--testimonial-shadow);
  }

  
  .testimonial-card.hidden {
    display: none;
  }

  
  .testimonial-card.show {
    display: flex;
    animation: fadeIn var(--testimonial-fade-duration) var(--transition-easing-default);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(var(--testimonial-fade-offset));
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .testimonial-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: var(--space-sm);
    border-bottom: var(--testimonial-border) solid var(--color-border-light);
  }

  .testimonial-rating {
    font-size: var(--font-size-h5);
    color: var(--color-accent);
  }

  .testimonial-source {
    font-size: var(--font-size-small);
    color: var(--tripadvisor-green); 
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
  }

  .testimonial-source:hover {
    text-decoration: underline;
  }

  .testimonial-title {
    font-size: var(--font-size-h5);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    line-height: var(--line-height-tight);
    margin: 0;
  }

  .testimonial-text {
    font-size: var(--font-size-body);
    color: var(--color-text-light);
    line-height: var(--line-height-relaxed);
    margin: 0;
    flex-grow: 1;
  }

  .testimonial-footer {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: var(--testimonial-border) solid var(--color-border-light);
  }

  .testimonial-author {
    display: flex;
    flex-direction: column;
    gap: var(--testimonial-author-gap);
  }

  .testimonial-author strong {
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }

  .testimonial-author span {
    font-size: var(--font-size-small);
    color: var(--color-text-muted);
  }

  .testimonial-tour-link {
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    color: var(--color-accent);
    transition: var(--testimonial-link-transition);
    align-self: flex-start;
  }

  .testimonial-tour-link:hover {
    color: var(--color-accent-light);
  }

  .section-cta {
    text-align: center;
  }

  .testimonials .section-cta .btn-outline-primary {
    border-color: transparent;
  }

  #testimonials-toggle:focus,
  #testimonials-toggle:focus-visible {
    outline: none;
    box-shadow: none;
  }

  .testimonials-toggle-icon {
    transition: transform var(--transition-duration-normal) var(--transition-easing-default);
  }

  #testimonials-toggle.is-collapsed .testimonials-toggle-icon {
    transform: rotate(-90deg);
  }

  
  @media (max-width: 768px) {
    .testimonials {
      padding: var(--space-2xl) 0;
    }

    .section-header {
      margin-bottom: var(--space-xl);
      padding-inline: var(--space-md);
    }

    .section-subtitle {
      font-size: var(--font-size-body);
    }

    .testimonials-grid {
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .testimonial-card {
      padding: var(--space-md);
      background: none;
      border: none;
      box-shadow: none;
    }

    .testimonial-title {
      font-size: var(--font-size-body);
    }

    .testimonial-text {
      font-size: var(--font-size-small);
    }
  }
</style>

<script>
  

  
  const toggleButton = document.getElementById("testimonials-toggle");
  const allCards = document.querySelectorAll(".testimonial-card");

  
  let expansionLevel = 0;

  
  function updateTestimonials() {
    
    allCards.forEach((card) => {
      const groupAttr = card.getAttribute("data-group");
      const group = groupAttr ? parseInt(groupAttr) : 0;

      
      if (expansionLevel === 0) {
        if (group === 1) {
          card.classList.remove("hidden");
          card.classList.add("show");
        } else {
          card.classList.add("hidden");
          card.classList.remove("show");
        }
        return;
      }

      if (expansionLevel === 1) {
        if (group <= 2) {
          card.classList.remove("hidden");
          card.classList.add("show");
        } else {
          card.classList.add("hidden");
          card.classList.remove("show");
        }
        return;
      }

      if (expansionLevel === 2) {
        if (group <= 3) {
          card.classList.remove("hidden");
          card.classList.add("show");
        } else {
          card.classList.add("hidden");
          card.classList.remove("show");
        }
        return;
      }

      card.classList.remove("hidden");
      card.classList.add("show");
    });

    
    if (toggleButton) {
      const label = toggleButton.querySelector(".testimonials-toggle-label");
      if (expansionLevel < 3) {
        if (label) {
          label.textContent =
            toggleButton.getAttribute("data-text-more") || "Read More Reviews";
        }
        toggleButton.classList.remove("is-collapsed");
      } else {
        if (label) {
          label.textContent =
            toggleButton.getAttribute("data-text-less") || "Show Less";
        }
        toggleButton.classList.add("is-collapsed");
      }
    }
  }

  
  toggleButton?.addEventListener("click", () => {
    
    expansionLevel = (expansionLevel + 1) % 4;

    
    if (expansionLevel === 0) {
      document.querySelector(".testimonials")?.scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    }

    
    updateTestimonials();
  });

  
  updateTestimonials();
</script>
