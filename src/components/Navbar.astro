---
// @ts-nocheck
/* ================================
   BE FREE TOURS - Navbar Component
   Navegação principal com dark/light toggle e seletor de idiomas
   CORRIGIDO: Detecta lang automaticamente
   ================================ */

import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { languages } from "../i18n/ui.js";

// CORREÇÃO: Detecta idioma da URL automaticamente (não espera prop)
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Detectar página atual para estado ativo
const currentPath = Astro.url.pathname;

// Mapeamento de rotas por idioma
const routes = {
  en: {
    home: "/",
    privateTours: "/private-tours",
    gallery: "/gallery",
    blog: "/blog",
    about: "/about",
    contact: "/contact",
  },
  es: {
    home: "/",
    privateTours: "/tours-privados",
    gallery: "/galeria",
    blog: "/blog",
    about: "/sobre",
    contact: "/contato",
  },
  "pt-br": {
    home: "/",
    privateTours: "/passeios-privados",
    gallery: "/galeria",
    blog: "/blog",
    about: "/sobre",
    contact: "/contato",
  },
};

const r = routes[lang];

// Links de navegação
const navLinks = [
  { href: `/${lang}${r.home}`, label: t("nav.home") },
  { href: `/${lang}${r.privateTours}`, label: t("nav.privateTours") },
  { href: `/${lang}${r.gallery}`, label: t("nav.gallery") },
  { href: `/${lang}${r.blog}`, label: t("nav.blog") },
  { href: `/${lang}${r.about}`, label: t("nav.about") },
  { href: `/${lang}${r.contact}`, label: t("nav.contact") },
];

// Função para verificar se o link está ativo
function isActive(href: string): boolean {
  // Home: só ativo se for exatamente a home
  if (href === `/${lang}/` || href === `/${lang}`) {
    return currentPath === `/${lang}` || currentPath === `/${lang}/`;
  }
  // Outros links: ativo se o path começa com o href
  return currentPath.startsWith(href);
}
---

<header role="banner">
  <nav class="navbar" role="navigation" aria-label="Main navigation" id="navigation">
  <div class="container">
    <div class="navbar-content">
      <!-- Logo -->
      <a href={`/${lang}`} class="navbar-logo">
        <img 
          src="/images/logo/logo.svg"
          alt="Be Free Tours" 
          width="48" 
          height="48"
          class="logo-image"
        />
      </a>

      <!-- Desktop Navigation -->
      <ul class="navbar-menu">
        {
          navLinks.map((link) => (
            <li>
              <a href={link.href} class={`nav-link ${isActive(link.href) ? 'active' : ''}`}>
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>

      <!-- Actions -->
      <div class="navbar-actions">
        <!-- Dark/Light Toggle -->
        <button id="theme-toggle" class="icon-button" aria-label="Toggle theme">
          <svg
            class="theme-icon sun-icon"
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M12 17.5c-3.03 0-5.5-2.47-5.5-5.5S8.97 6.5 12 6.5s5.5 2.47 5.5 5.5-2.47 5.5-5.5 5.5zM12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 0 0-1.41 0 .996.996 0 0 0 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 0 0 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 0 0 0-1.41.996.996 0 0 0-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"
            ></path>
          </svg>
          <svg
            class="theme-icon moon-icon"
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M9 2c-1.05 0-2.05.16-3 .46 4.06 1.27 7 5.06 7 9.54 0 4.48-2.94 8.27-7 9.54.95.3 1.95.46 3 .46 5.52 0 10-4.48 10-10S14.52 2 9 2z"
            ></path>
          </svg>
        </button>

        <!-- Language Selector -->
        <div class="language-selector">
          <button
            id="lang-toggle"
            class="icon-button"
            aria-label={t("nav.language")}
          >
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95a15.65 15.65 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A7.987 7.987 0 0 1 5.08 16zm2.95-8H5.08a7.987 7.987 0 0 1 4.33-3.56A15.65 15.65 0 0 0 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"
              ></path>
            </svg>
            <span class="lang-current">{lang.toUpperCase()}</span>
          </button>

          <div id="lang-dropdown" class="lang-dropdown" hidden>
            {
              Object.entries(languages).map(([code, name]) => (
                <a
                  href={`/${code}`}
                  class={`lang-option ${code === lang ? "active" : ""}`}
                  data-lang={code}
                >
                  <span class="lang-code">{code.toUpperCase()}</span>
                  <span class="lang-name">{name}</span>
                </a>
              ))
            }
          </div>
        </div>

        <!-- CTA Button -->
        <a href={`/${lang}/contact`} class="btn btn-primary btn-sm navbar-cta">
          {t("nav.book")}
        </a>

        <!-- Mobile Menu Toggle -->
        <button
          id="mobile-menu-toggle"
          class="mobile-menu-button"
          aria-label="Toggle menu"
        >
          <svg
            class="menu-icon"
            width="24"
            height="24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            viewBox="0 0 24 24"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
          <svg
            class="close-icon"
            width="24"
            height="24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            viewBox="0 0 24 24"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="mobile-menu" hidden>
      <ul class="mobile-menu-list">
        {
          navLinks.map((link) => (
            <li>
              <a href={link.href} class={`mobile-nav-link ${isActive(link.href) ? 'active' : ''}`}>
                {link.label}
              </a>
            </li>
          ))
        }
        <li>
          <a href={`/${lang}/contact`} class="mobile-nav-link mobile-nav-cta">
            {t("nav.book")}
          </a>
        </li>
      </ul>
    </div>
  </div>
  </nav>
</header>

<style>
  .navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(10, 22, 40, 0.8);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--glass-border);
    transition: background-color 0.3s ease;
  }

  /* Tema claro: Navbar permanece ESCURA (âncora visual) */
  :global(html.light) .navbar {
    background: rgba(15, 23, 42, 0.95);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .navbar.scrolled {
    background: rgba(10, 22, 40, 0.95);
  }

  :global(html.light) .navbar.scrolled {
    background: rgba(15, 23, 42, 0.98);
  }

  .navbar-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) 0;
    gap: var(--space-lg);
  }

  /* Logo */
  .navbar-logo {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .navbar-logo:hover {
    opacity: 0.8;
  }

  .logo-image {
    width: 48px;
    height: 48px;
    object-fit: contain;
    background: transparent !important;
  }

  .logo-subtext {
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-light);
  }

  /* Desktop Menu */
  .navbar-menu {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: var(--space-md); /* Reduzido de --space-lg para caber mais itens */
  }

  .nav-link {
    color: var(--color-text-light);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    transition: color 0.2s ease, background-color 0.2s ease;
  }

  .nav-link:hover,
  .nav-link.active {
    color: var(--color-text);
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Tema claro: links brancos na navbar escura */
  :global(html.light) .nav-link {
    color: rgba(255, 255, 255, 0.8);
  }

  :global(html.light) .nav-link:hover,
  :global(html.light) .nav-link.active {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Actions */
  .navbar-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .icon-button {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs);
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .icon-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--color-text);
  }

  /* Tema claro: ícones brancos na navbar escura */
  :global(html.light) .icon-button {
    color: rgba(255, 255, 255, 0.8);
  }

  :global(html.light) .icon-button:hover {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
  }

  :global(html.light) .lang-current {
    color: rgba(255, 255, 255, 0.9);
  }

  /* Theme Toggle */
  .sun-icon {
    display: none;
  }

  .moon-icon {
    display: block;
  }

  :global(html.light) .sun-icon {
    display: block;
  }

  :global(html.light) .moon-icon {
    display: none;
  }

  :global(html.dark) .sun-icon {
    display: none;
  }

  :global(html.dark) .moon-icon {
    display: block;
  }

  /* Language Selector */
  .language-selector {
    position: relative;
  }

  .lang-current {
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-semibold);
  }

  .lang-dropdown {
    position: absolute;
    top: calc(100% + var(--space-xs));
    right: 0;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    box-shadow: var(--glass-shadow);
    padding: var(--space-xs);
    min-width: 160px;
    z-index: 100;
  }

  .lang-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    text-decoration: none;
    color: var(--color-text);
    transition: background-color 0.2s ease;
  }

  .lang-option:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .lang-option.active {
    background: var(--gradient-accent);
    color: white;
  }

  .lang-code {
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-small);
  }

  .lang-name {
    font-size: var(--font-size-small);
  }

  /* CTA Button */
  .navbar-cta {
    display: none;
  }

  /* Mobile Menu Button */
  .mobile-menu-button {
    display: flex;
    padding: var(--space-xs);
    background: none;
    border: none;
    color: var(--color-text);
    cursor: pointer;
  }

  .close-icon {
    display: none;
  }

  .mobile-menu-button[aria-expanded="true"] .menu-icon {
    display: none;
  }

  .mobile-menu-button[aria-expanded="true"] .close-icon {
    display: block;
  }

  /* Mobile Menu */
  .mobile-menu {
    padding: var(--space-lg) 0;
    border-top: 1px solid var(--glass-border);
    background: var(--glass-bg);
  }

  .mobile-menu-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .mobile-nav-link {
    display: block;
    padding: var(--space-md);
    color: var(--color-text);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-md);
    transition: background-color 0.2s ease;
  }

  .mobile-nav-link:hover,
  .mobile-nav-link.active {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .mobile-nav-cta {
    background: var(--gradient-accent);
    color: white;
    text-align: center;
    font-weight: var(--font-weight-semibold);
  }

  .mobile-nav-cta:hover {
    background: var(--color-accent-light);
  }

  /* Desktop */
  @media (min-width: 769px) {
    .navbar-menu {
      display: flex;
    }

    .navbar-cta {
      display: inline-flex;
    }

    .mobile-menu-button {
      display: none;
    }
  }
</style>

<script>
  /* ================================
     JAVASCRIPT - Navbar Interactions
     ================================ */

  // Theme Toggle
  const themeToggle = document.getElementById("theme-toggle");
  const html = document.documentElement;

  // Load saved theme - default to dark (novo design)
  const savedTheme = localStorage.getItem("theme") || "dark";

  // Apply initial theme
  function applyTheme(theme: string) {
    if (theme === "light") {
      html.classList.add("light");
      html.classList.remove("dark");
    } else {
      html.classList.add("dark");
      html.classList.remove("light");
    }
  }

  // Apply on load
  applyTheme(savedTheme);

  themeToggle?.addEventListener("click", () => {
    const isCurrentlyLight = html.classList.contains("light");
    const newTheme = isCurrentlyLight ? "dark" : "light";
    
    applyTheme(newTheme);
    localStorage.setItem("theme", newTheme);
  });

  // Language Dropdown
  const langToggle = document.getElementById("lang-toggle");
  const langDropdown = document.getElementById("lang-dropdown");

  langToggle?.addEventListener("click", () => {
    const isHidden = langDropdown?.hasAttribute("hidden");
    if (isHidden) {
      langDropdown?.removeAttribute("hidden");
    } else {
      langDropdown?.setAttribute("hidden", "");
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (
      !langToggle?.contains(e.target as Node) &&
      !langDropdown?.contains(e.target as Node)
    ) {
      langDropdown?.setAttribute("hidden", "");
    }
  });

  // Mobile Menu Toggle
  const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");

  mobileMenuToggle?.addEventListener("click", () => {
    const isExpanded =
      mobileMenuToggle.getAttribute("aria-expanded") === "true";

    if (isExpanded) {
      mobileMenuToggle.setAttribute("aria-expanded", "false");
      mobileMenu?.setAttribute("hidden", "");
    } else {
      mobileMenuToggle.setAttribute("aria-expanded", "true");
      mobileMenu?.removeAttribute("hidden");
    }
  });
</script>
